- name: Configure CI/CD demo app
  hosts: local
  gather_facts: false
  vars:
    namespace: "{{ namespace | default('cicd-demo') }}"
    configmap_name: "{{ configmap_name | default('cicd-demo-env') }}"
    deploy_dir: "{{ playbook_dir }}/../../deploy"
    environment: "{{ environment | default('dev') }}"
    release_color: "{{ release_color | default('blue') }}"
    build_id: "{{ build_id | default('local') }}"
    git_sha: "{{ git_sha | default('dev') }}"
    deploy_mode: "{{ deploy_mode | default('blue-green') }}"
  tasks:
    - name: Ensure deploy directory exists
      ansible.builtin.file:
        path: "{{ deploy_dir }}"
        state: directory
        mode: "0755"

    - name: Render environment file
      ansible.builtin.template:
        src: ../templates/app.env.j2
        dest: "{{ deploy_dir }}/app.env"
        mode: "0644"

    - name: Build namespace manifest
      ansible.builtin.command: >
        kubectl create namespace {{ namespace }}
        --dry-run=client -o yaml
      register: namespace_manifest
      changed_when: false

    - name: Apply namespace manifest
      ansible.builtin.command: kubectl apply -f -
      args:
        stdin: "{{ namespace_manifest.stdout }}"

    - name: Build configmap manifest
      ansible.builtin.command: >
        kubectl -n {{ namespace }}
        create configmap {{ configmap_name }}
        --from-env-file={{ deploy_dir }}/app.env
        --dry-run=client -o yaml
      register: configmap_manifest
      changed_when: false

    - name: Apply configmap manifest
      ansible.builtin.command: kubectl -n {{ namespace }} apply -f -
      args:
        stdin: "{{ configmap_manifest.stdout }}"
