pipeline {
  agent any

  options {
    timestamps()
  }

  parameters {
    choice(name: "DEPLOY_MODE", choices: ["blue-green", "rolling"], description: "Deployment strategy")
    choice(name: "RELEASE_COLOR", choices: ["blue", "green"], description: "Release color for blue-green")
    string(name: "ENVIRONMENT", defaultValue: "dev", description: "Target environment")
    string(name: "TF_ENV", defaultValue: "local-kind", description: "Terraform environment folder")
    booleanParam(name: "AUTO_APPLY", defaultValue: false, description: "Run Terraform apply")
    booleanParam(name: "AUTO_DEPLOY", defaultValue: false, description: "Deploy to Kubernetes")
  }

  environment {
    IMAGE_NAME = "cicd-demo"
    IMAGE_TAG = "${BUILD_NUMBER}"
  }

  stages {
    stage("Install") {
      steps {
        sh "npm install"
      }
    }

    stage("Lint") {
      steps {
        sh "npm run lint"
      }
    }

    stage("Unit Tests") {
      steps {
        sh "npm run test:unit"
      }
    }

    stage("Integration Tests") {
      steps {
        sh "npm run test:integration"
      }
    }

    stage("E2E Tests") {
      steps {
        sh "npm run test:e2e"
      }
    }

    stage("Docker Build") {
      steps {
        sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
      }
    }

    stage("Terraform Plan") {
      steps {
        sh "terraform -chdir=terraform/environments/${TF_ENV} init -input=false"
        sh """
          terraform -chdir=terraform/environments/${TF_ENV} plan -input=false \
            -var=\\"image=${IMAGE_NAME}:${IMAGE_TAG}\\" \
            -var=\\"deploy_mode=${DEPLOY_MODE}\\" \
            -var=\\"release_color=${RELEASE_COLOR}\\" \
            -var=\\"environment=${ENVIRONMENT}\\" \
            -var=\\"build_id=${IMAGE_TAG}\\" \
            -var=\\"git_sha=${env.GIT_COMMIT ?: 'dev'}\\"
        """
      }
    }

    stage("Terraform Apply") {
      when {
        expression { return params.AUTO_APPLY }
      }
      steps {
        sh """
          terraform -chdir=terraform/environments/${TF_ENV} apply -auto-approve \
            -var=\\"image=${IMAGE_NAME}:${IMAGE_TAG}\\" \
            -var=\\"deploy_mode=${DEPLOY_MODE}\\" \
            -var=\\"release_color=${RELEASE_COLOR}\\" \
            -var=\\"environment=${ENVIRONMENT}\\" \
            -var=\\"build_id=${IMAGE_TAG}\\" \
            -var=\\"git_sha=${env.GIT_COMMIT ?: 'dev'}\\"
        """
      }
    }

    stage("Ansible Config") {
      steps {
        sh """
          ansible-playbook -i ansible/inventory/local.ini ansible/playbooks/configure-app.yml \
            -e \\"environment=${ENVIRONMENT}\\" \
            -e \\"release_color=${RELEASE_COLOR}\\" \
            -e \\"build_id=${IMAGE_TAG}\\" \
            -e \\"git_sha=${env.GIT_COMMIT ?: 'dev'}\\" \
            -e \\"deploy_mode=${DEPLOY_MODE}\\"
        """
      }
    }

    stage("Deploy") {
      when {
        expression { return params.AUTO_DEPLOY }
      }
      steps {
        script {
          if (params.DEPLOY_MODE == "rolling") {
            sh "IMAGE=${IMAGE_NAME}:${IMAGE_TAG} ./scripts/rolling.sh"
          } else {
            sh "./scripts/blue-green.sh ${RELEASE_COLOR}"
          }
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: "deploy/app.env", allowEmptyArchive: true
    }
  }
}
