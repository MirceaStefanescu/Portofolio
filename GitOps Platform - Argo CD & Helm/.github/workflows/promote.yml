name: Promote GitOps Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment (dev, staging, prod)
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      image_tag:
        description: Image tag to promote
        required: true
      strategy:
        description: Rollout strategy override (optional)
        required: false

permissions:
  contents: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update environment values
        run: |
          ./scripts/promote.sh "${{ inputs.environment }}" "${{ inputs.image_tag }}" "${{ inputs.strategy }}"

      - name: Commit and push
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes to commit"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "promote: ${{ inputs.environment }} -> ${{ inputs.image_tag }}"
          git push
